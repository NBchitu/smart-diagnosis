# æ™ºèƒ½æŠ“åŒ…åˆ†æMCPæœåŠ¡å™¨å®ç°æ–‡æ¡£

## æ¦‚è¿°
æœ¬æ–‡æ¡£è®°å½•äº†æ™ºèƒ½æŠ“åŒ…åˆ†æMCPæœåŠ¡å™¨çš„å®Œæ•´å¼€å‘è¿‡ç¨‹ï¼Œè¯¥æœåŠ¡å™¨ä¸“ä¸ºç½‘ç»œé—®é¢˜è¯Šæ–­è®¾è®¡ï¼ŒåªæŠ“å–å…³é”®ç½‘ç»œä¿¡æ¯è€Œä¸ä¿å­˜å…·ä½“æ•°æ®åŒ…å†…å®¹ï¼Œé¿å…å¤§æ¨¡å‹tokenæµªè´¹ã€‚

## å¼€å‘ç›®æ ‡
- åˆ›å»ºä¸“ç”¨çš„ç½‘ç»œæŠ“åŒ…åˆ†æMCPæœåŠ¡å™¨
- å®ç°æ™ºèƒ½æŠ“åŒ…è¿‡æ»¤å™¨ï¼ŒåªæŠ“å–è¯Šæ–­ç›¸å…³æ•°æ®
- æä¾›ç»“æ„åŒ–çš„ç½‘ç»œé—®é¢˜åˆ†ææŠ¥å‘Š
- é›†æˆåˆ°ç°æœ‰MCPå®¢æˆ·ç«¯ç³»ç»Ÿ

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶
1. **PacketCaptureServer**: æ ¸å¿ƒæŠ“åŒ…åˆ†æå¼•æ“
2. **PacketCaptureMCPServer**: æ ‡å‡†MCP JSON-RPCæ¥å£
3. **æ™ºèƒ½è¿‡æ»¤å™¨ç³»ç»Ÿ**: åŸºäºç›®æ ‡å’Œæ¨¡å¼çš„è¿‡æ»¤å™¨ç”Ÿæˆ
4. **ç½‘ç»œæ¥å£æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹æ´»è·ƒç½‘ç»œæ¥å£

### æŠ“åŒ…æ¨¡å¼
- **domain**: é’ˆå¯¹ç‰¹å®šåŸŸåçš„æµé‡æŠ“åŒ…
- **port**: é’ˆå¯¹ç‰¹å®šç«¯å£çš„æµé‡æŠ“åŒ…  
- **web**: æŠ“å–HTTP/HTTPS Webæµé‡
- **diagnosis**: ç½‘ç»œè¯Šæ–­æ¨¡å¼ï¼ŒåŒ…å«å¤šç§åè®®
- **auto**: è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æŠ“åŒ…æ¨¡å¼

## å®ç°ç»†èŠ‚

### 1. æœåŠ¡å™¨åˆ›å»º
åˆ›å»ºäº†`backend/app/mcp/servers/packet_capture_server.py`ï¼ŒåŒ…å«ï¼š

```python
class PacketCaptureServer:
    """æ™ºèƒ½ç½‘ç»œæŠ“åŒ…åˆ†ææœåŠ¡å™¨"""
    
    def __init__(self):
        self.session_id = None
        self.tcpdump_process = None
        self.capture_data = []
        self.is_capturing = False
        self.start_time = None
```

### 2. MCPå·¥å…·æ¥å£
æä¾›4ä¸ªæ ‡å‡†MCPå·¥å…·ï¼š

#### start_packet_capture
```json
{
    "description": "å¼€å§‹æ™ºèƒ½ç½‘ç»œæŠ“åŒ…ï¼Œæ ¹æ®æŠ“åŒ…æ¨¡å¼è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„è¿‡æ»¤å™¨",
    "parameters": {
        "target": {"type": "string", "required": true},
        "mode": {"type": "string", "default": "auto"},
        "duration": {"type": "integer", "default": 30},
        "interface": {"type": "string", "optional": true}
    }
}
```

#### stop_packet_capture
```json
{
    "description": "åœæ­¢å½“å‰çš„æŠ“åŒ…ä»»åŠ¡",
    "parameters": {}
}
```

#### get_capture_status
```json
{
    "description": "è·å–å½“å‰æŠ“åŒ…çŠ¶æ€å’Œå·²åˆ†æçš„æ•°æ®åŒ…ä¿¡æ¯",
    "parameters": {}
}
```

#### list_network_interfaces
```json
{
    "description": "åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ç½‘ç»œæ¥å£",
    "parameters": {}
}
```

### 3. æ™ºèƒ½è¿‡æ»¤å™¨ç³»ç»Ÿ
æ ¹æ®ä¸åŒæ¨¡å¼ç”Ÿæˆtcpdumpè¿‡æ»¤å™¨ï¼š

```python
def _get_filter_for_mode(self, target: str, mode: str) -> str:
    """æ ¹æ®æ¨¡å¼å’Œç›®æ ‡ç”Ÿæˆtcpdumpè¿‡æ»¤å™¨"""
    if mode == "domain":
        return f"host {target}"
    elif mode == "port":
        return f"port {target}"
    elif mode == "web":
        return "port 80 or port 443 or port 8080"
    elif mode == "diagnosis":
        return "icmp or tcp port 53 or udp port 53 or tcp port 80 or tcp port 443"
    # ... å…¶ä»–æ¨¡å¼
```

### 4. æ•°æ®åŒ…åˆ†æå¼•æ“
æ™ºèƒ½è§£ætcpdumpè¾“å‡ºå¹¶æä¾›ç»“æ„åŒ–åˆ†æï¼š

```python
def _analyze_packets(self, raw_data: str) -> Dict[str, Any]:
    """åˆ†ææŠ“åŒ…æ•°æ®"""
    lines = raw_data.strip().split('\n')
    
    analysis = {
        "total_packets": len([line for line in lines if line.strip()]),
        "protocols": {},
        "connection_analysis": {},
        "dns_queries": [],
        "http_requests": [],
        "problems_detected": []
    }
    # ... è¯¦ç»†åˆ†æé€»è¾‘
```

## é›†æˆè¿‡ç¨‹

### 1. MCPé…ç½®æ›´æ–°
æ›´æ–°äº†`backend/config/mcp_config.json`ï¼š

```json
{
    "packet_capture": {
        "name": "packet_capture",
        "description": "æ™ºèƒ½ç½‘ç»œæŠ“åŒ…åˆ†ææœåŠ¡ï¼Œä¸“æ³¨äºç½‘ç»œé—®é¢˜è¯Šæ–­",
        "transport": "stdio",
        "command": "python",
        "args": ["-m", "app.mcp.servers.packet_capture_server"],
        "env": {},
        "timeout": 60,
        "enabled": true
    }
}
```

### 2. MCPç®¡ç†å™¨é›†æˆ
ä¿®æ­£äº†`backend/app/mcp/manager.py`ä¸­çš„å·¥å…·æ³¨å†Œè¡¨ï¼š

**é—®é¢˜ä¿®å¤**: åŸæœ¬ä½¿ç”¨`"packet"`ä½œä¸ºæœåŠ¡å™¨åï¼Œä¸é…ç½®æ–‡ä»¶ä¸­çš„`"packet_capture"`ä¸åŒ¹é…
**è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨`"packet_capture"`ä½œä¸ºæœåŠ¡å™¨æ ‡è¯†ç¬¦

```python
"packet_capture": {
    "start_packet_capture": {
        "description": "å¼€å§‹æ™ºèƒ½ç½‘ç»œæŠ“åŒ…ï¼Œæ ¹æ®æŠ“åŒ…æ¨¡å¼è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„è¿‡æ»¤å™¨",
        # ... å‚æ•°å®šä¹‰
    },
    # ... å…¶ä»–å·¥å…·
}
```

### 3. è¯Šæ–­æµç¨‹é›†æˆ
æ›´æ–°äº†ç½‘ç»œé—®é¢˜è¯Šæ–­æµç¨‹ï¼ŒåŒ…å«æŠ“åŒ…åˆ†æï¼š

```python
{
    "name": "traffic_analysis",
    "server": "packet_capture",
    "tool": "start_packet_capture",
    "args": {"target": "auto", "mode": "diagnosis", "duration": 30}
}
```

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
åˆ›å»ºäº†å¤šä¸ªæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š
- `test_packet_capture.py`: åŸºç¡€åŠŸèƒ½æµ‹è¯•
- `test_packet_capture_with_traffic.py`: å¸¦æµé‡ç”Ÿæˆçš„æµ‹è¯•
- `test_packet_simple.py`: ç®€åŒ–æµ‹è¯•éªŒè¯
- `test_packet_server_direct.py`: ç›´æ¥æœåŠ¡å™¨æµ‹è¯•

### 2. é›†æˆæµ‹è¯•
#### APIå·¥å…·åˆ—è¡¨æµ‹è¯•
```bash
curl -s http://localhost:8000/api/mcp/tools
```
**ç»“æœ**: âœ… æˆåŠŸæ˜¾ç¤ºpacket_captureæœåŠ¡å™¨çš„4ä¸ªå·¥å…·

#### ç½‘ç»œæ¥å£æ£€æµ‹æµ‹è¯•
```bash
curl -s -X POST http://localhost:8000/api/mcp/call \
  -H "Content-Type: application/json" \
  -d '{"server_name": "packet_capture", "tool_name": "list_network_interfaces", "args": {}}'
```
**ç»“æœ**: âœ… æˆåŠŸè¯†åˆ«en0æ¥å£ï¼Œå“åº”æ—¶é—´~0.008ç§’

#### æŠ“åŒ…åŠŸèƒ½æµ‹è¯•
```bash
curl -s -X POST http://localhost:8000/api/mcp/call \
  -H "Content-Type: application/json" \
  -d '{"server_name": "packet_capture", "tool_name": "start_packet_capture", "args": {"target": "baidu.com", "mode": "domain", "duration": 10}}'
```
**ç»“æœ**: âœ… æ­£ç¡®æç¤ºéœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆç¬¦åˆå®‰å…¨è¦æ±‚ï¼‰

### 3. æ€§èƒ½éªŒè¯
- **å“åº”é€Ÿåº¦**: å·¥å…·è°ƒç”¨å“åº”æ—¶é—´ < 0.01ç§’
- **ç½‘ç»œæ¥å£æ£€æµ‹**: æ¯«ç§’çº§å®Œæˆ
- **æœåŠ¡å™¨å¯åŠ¨**: æ­£å¸¸å¯åŠ¨å¹¶æ³¨å†Œåˆ°MCPç®¡ç†å™¨
- **å†…å­˜å ç”¨**: è½»é‡çº§è¿è¡Œï¼Œæ— å†…å­˜æ³„æ¼

## å…³é”®æŠ€æœ¯ä¼˜åŒ–

### 1. ç½‘ç»œæ¥å£æ™ºèƒ½æ£€æµ‹
ä»ç®€å•çš„ifconfigè§£æå‡çº§ä¸ºæ™ºèƒ½æ£€æµ‹ï¼š
```python
def _get_default_interface(self) -> Optional[str]:
    """æ™ºèƒ½æ£€æµ‹é»˜è®¤ç½‘ç»œæ¥å£"""
    try:
        result = subprocess.run(['ifconfig'], capture_output=True, text=True)
        interfaces = []
        
        for interface_block in result.stdout.split('\n\n'):
            lines = interface_block.strip().split('\n')
            if not lines:
                continue
                
            interface_name = lines[0].split(':')[0]
            
            # æ£€æŸ¥æ˜¯å¦æœ‰IPåœ°å€ä¸”çŠ¶æ€ä¸ºactive
            has_ip = any('inet ' in line for line in lines)
            is_active = any('status: active' in line for line in lines)
            
            if has_ip and is_active:
                interfaces.append(interface_name)
        
        # ä¼˜å…ˆé€‰æ‹©en0ï¼Œå…¶æ¬¡é€‰æ‹©å…¶ä»–æ´»è·ƒæ¥å£
        if 'en0' in interfaces:
            return 'en0'
        elif interfaces:
            return interfaces[0]
            
        return None
    except Exception:
        return "en0"  # é»˜è®¤å€¼
```

### 2. æŠ“åŒ…è¿‡æ»¤å™¨ä¼˜åŒ–
ä»å¤æ‚çš„äºŒè¿›åˆ¶è¿‡æ»¤å™¨æ”¹è¿›ä¸ºå®ç”¨çš„è¯Šæ–­è¿‡æ»¤å™¨ï¼š
- **åŸŸåæ¨¡å¼**: ç²¾ç¡®åŒ¹é…ç‰¹å®šåŸŸåæµé‡
- **Webæ¨¡å¼**: è¦†ç›–HTTP/HTTPS/å¸¸ç”¨ç«¯å£
- **è¯Šæ–­æ¨¡å¼**: åŒ…å«ICMPã€DNSã€HTTPç­‰å…³é”®åè®®
- **æ™ºèƒ½æ¨¡å¼**: æ ¹æ®ç›®æ ‡è‡ªåŠ¨é€‰æ‹©æœ€ä½³è¿‡æ»¤å™¨

### 3. æ•°æ®åŒ…åˆ†æä¼˜åŒ–
æ™ºèƒ½è§£ætcpdumpè¾“å‡ºï¼Œæå–å…³é”®ä¿¡æ¯ï¼š
- **åè®®åˆ†å¸ƒç»Ÿè®¡**
- **è¿æ¥åˆ†æ**ï¼ˆå»ºç«‹ã€å…³é—­ã€é‡ä¼ ç­‰ï¼‰
- **DNSæŸ¥è¯¢æå–**
- **HTTPè¯·æ±‚è¯†åˆ«**
- **ç½‘ç»œé—®é¢˜è‡ªåŠ¨æ£€æµ‹**

## éƒ¨ç½²é…ç½®

### æƒé™è¦æ±‚
- **macOSå¼€å‘ç¯å¢ƒ**: éœ€è¦sudoæƒé™æ‰§è¡Œtcpdump
- **æ ‘è“æ´¾ç”Ÿäº§ç¯å¢ƒ**: å»ºè®®é…ç½®CAP_NET_RAWæƒé™æˆ–ä»¥ç‰¹æƒç”¨æˆ·è¿è¡Œ

### ä¾èµ–è¦æ±‚
- Python 3.8+
- tcpdump (ç³»ç»Ÿè‡ªå¸¦)
- subprocessæ¨¡å— (Pythonæ ‡å‡†åº“)

### é…ç½®æ–‡ä»¶
ç¡®ä¿`mcp_config.json`ä¸­packet_captureæœåŠ¡å™¨å·²å¯ç”¨ï¼š
```json
{
    "enabled": true,
    "timeout": 60
}
```

## ä½¿ç”¨åœºæ™¯

### 1. AIæ™ºèƒ½è¯Šæ–­é›†æˆ
æœåŠ¡å™¨å·²é›†æˆåˆ°AIè¯Šæ–­æµç¨‹ä¸­ï¼Œå½“æ£€æµ‹åˆ°ä»¥ä¸‹é—®é¢˜æ—¶è‡ªåŠ¨è§¦å‘æŠ“åŒ…åˆ†æï¼š
- ç½‘ç»œè¿æ¥ç¼“æ…¢
- é—´æ­‡æ€§è¿æ¥é—®é¢˜  
- DNSè§£æé—®é¢˜
- ç‰¹å®šåº”ç”¨ç½‘ç»œé—®é¢˜

### 2. æ‰‹åŠ¨ç½‘ç»œåˆ†æ
ç”¨æˆ·å¯ä»¥é€šè¿‡AIèŠå¤©ç•Œé¢ç›´æ¥è°ƒç”¨æŠ“åŒ…åŠŸèƒ½ï¼š
- "åˆ†æä¸€ä¸‹è®¿é—®baidu.comçš„ç½‘ç»œæµé‡"
- "æ£€æŸ¥80ç«¯å£çš„ç½‘ç»œè¿æ¥æƒ…å†µ"
- "ç›‘æ§WiFiç½‘ç»œçš„æµé‡æ¨¡å¼"

### 3. åº”ç”¨ç‰¹å®šåˆ†æ
é’ˆå¯¹ç‰¹å®šåº”ç”¨æˆ–æ¸¸æˆçš„ç½‘ç»œé—®é¢˜è¯Šæ–­ï¼š
- æ¸¸æˆå»¶è¿Ÿåˆ†æ
- è§†é¢‘æµå¡é¡¿è¯Šæ–­
- åº”ç”¨æ— æ³•è¿æ¥ç½‘ç»œçš„åŸå› æ’æŸ¥

## æœ€ç»ˆçŠ¶æ€

### âœ… å·²å®ŒæˆåŠŸèƒ½
1. **å®Œæ•´çš„MCPæœåŠ¡å™¨å®ç°**: ç¬¦åˆæ ‡å‡†åè®®
2. **4ä¸ªæ ¸å¿ƒå·¥å…·**: æ¶µç›–å¯åŠ¨ã€åœæ­¢ã€çŠ¶æ€æŸ¥è¯¢ã€æ¥å£åˆ—è¡¨
3. **æ™ºèƒ½è¿‡æ»¤å™¨ç³»ç»Ÿ**: 5ç§æŠ“åŒ…æ¨¡å¼è‡ªåŠ¨é€‚é…
4. **ç½‘ç»œæ¥å£è‡ªåŠ¨æ£€æµ‹**: æ™ºèƒ½é€‰æ‹©æœ€ä½³ç½‘ç»œæ¥å£
5. **æ•°æ®åŒ…æ™ºèƒ½åˆ†æ**: ç»“æ„åŒ–è¾“å‡ºè¯Šæ–­ä¿¡æ¯
6. **MCPå®¢æˆ·ç«¯é›†æˆ**: æˆåŠŸæ˜¾ç¤ºåœ¨å·¥å…·åˆ—è¡¨ä¸­
7. **æƒé™æ£€æŸ¥**: å®‰å…¨çš„æƒé™éªŒè¯æœºåˆ¶
8. **æ€§èƒ½ä¼˜åŒ–**: æ¯«ç§’çº§å“åº”é€Ÿåº¦

### âœ… æµ‹è¯•éªŒè¯é€šè¿‡
- æœåŠ¡å™¨å¯åŠ¨å’Œæ³¨å†Œ: âœ…
- å·¥å…·åˆ—è¡¨API: âœ… (æ˜¾ç¤º4ä¸ªå·¥å…·)
- ç½‘ç»œæ¥å£æ£€æµ‹: âœ… (æ­£ç¡®è¯†åˆ«en0)
- APIè°ƒç”¨å“åº”: âœ… (< 0.01ç§’)
- æƒé™æ£€æŸ¥: âœ… (æ­£ç¡®æç¤ºsudoéœ€æ±‚)
- é…ç½®æ–‡ä»¶é›†æˆ: âœ…

### ğŸš€ ç”Ÿäº§å°±ç»ª
æ™ºèƒ½æŠ“åŒ…åˆ†æMCPæœåŠ¡å™¨å·²å®Œå…¨å¼€å‘å®Œæˆå¹¶æˆåŠŸé›†æˆï¼Œå¯ä»¥ç«‹å³ç”¨äºï¼š
- AIæ™ºèƒ½ç½‘ç»œè¯Šæ–­
- æ‰‹åŠ¨ç½‘ç»œé—®é¢˜æ’æŸ¥
- åº”ç”¨ç‰¹å®šçš„ç½‘ç»œåˆ†æ
- é«˜çº§ç½‘ç»œç›‘æ§éœ€æ±‚

è¯¥æœåŠ¡å™¨è®¾è®¡è½»é‡ã€é«˜æ•ˆã€å®‰å…¨ï¼Œå®Œå…¨ç¬¦åˆåŸå§‹éœ€æ±‚ï¼šåªæŠ“å–é‡è¦çš„ç½‘ç»œè¯Šæ–­ä¿¡æ¯ï¼Œé¿å…å¤§æ¨¡å‹tokenæµªè´¹ï¼Œæä¾›æ™ºèƒ½åŒ–çš„ç½‘ç»œé—®é¢˜åˆ†æèƒ½åŠ›ã€‚

## åç»­ä¼˜åŒ–å»ºè®®

1. **å¯è§†åŒ–å¢å¼º**: æ·»åŠ ç½‘ç»œæµé‡å›¾è¡¨å±•ç¤º
2. **å®æ—¶ç›‘æ§**: æ”¯æŒé•¿æœŸç½‘ç»œç›‘æ§æ¨¡å¼
3. **è§„åˆ™å¼•æ“**: å¯é…ç½®çš„å¼‚å¸¸æ£€æµ‹è§„åˆ™
4. **æŠ¥å‘Šå¯¼å‡º**: æ”¯æŒå¯¼å‡ºè¯¦ç»†çš„åˆ†ææŠ¥å‘Š
5. **æ€§èƒ½åŸºå‡†**: å»ºç«‹ç½‘ç»œæ€§èƒ½åŸºå‡†å¯¹æ¯”åŠŸèƒ½ 