# æŠ“åŒ…ç›‘æ§é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸš¨ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šåœ¨AIè¯Šæ–­é¡µé¢å‘èµ·æŠ“åŒ…ä»»åŠ¡åå‡ºç°æ§åˆ¶å°é”™è¯¯ï¼š

```
Error: è·å–æŠ“åŒ…çŠ¶æ€å¤±è´¥
components/ai-diagnosis/ChatInterface.tsx (121:15) @ ChatInterface.useCallback[pollCaptureStatus]
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

1. **æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜**ï¼šä½¿ç”¨äº†è¾ƒæ–°çš„`AbortSignal.timeout()`APIï¼Œåœ¨æŸäº›æµè§ˆå™¨ä¸­ä¸æ”¯æŒ
2. **é”™è¯¯ä¿¡æ¯ä¸è¯¦ç»†**ï¼šåŸå§‹é”™è¯¯å¤„ç†åªæä¾›é€šç”¨é”™è¯¯ä¿¡æ¯ï¼Œéš¾ä»¥å®šä½å…·ä½“é—®é¢˜
3. **ç¼ºä¹é‡è¯•æœºåˆ¶**ï¼šç½‘ç»œä¸´æ—¶æ•…éšœæ—¶æ²¡æœ‰è‡ªåŠ¨é‡è¯•æœºåˆ¶
4. **æ— å¤±è´¥çŠ¶æ€æ˜¾ç¤º**ï¼šç”¨æˆ·æ— æ³•çœ‹åˆ°è½®è¯¢å¤±è´¥çš„å…·ä½“çŠ¶æ€

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æµè§ˆå™¨å…¼å®¹æ€§ä¿®å¤
**é—®é¢˜**ï¼š`AbortSignal.timeout()` ä¸è¢«æ‰€æœ‰æµè§ˆå™¨æ”¯æŒ

**ä¿®å¤**ï¼šä½¿ç”¨å…¼å®¹çš„ `AbortController` + `setTimeout` æ–¹å¼
```typescript
// ä¿®å¤å‰
signal: AbortSignal.timeout(10000)

// ä¿®å¤å
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 10000);
signal: controller.signal;
clearTimeout(timeoutId); // è¯·æ±‚æˆåŠŸåæ¸…é™¤
```

### 2. è¯¦ç»†é”™è¯¯è¯Šæ–­
**é—®é¢˜**ï¼šé”™è¯¯ä¿¡æ¯è¿‡äºç®€å•ï¼Œæ— æ³•å®šä½é—®é¢˜

**ä¿®å¤**ï¼šæ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ—¥å¿—
```typescript
console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', {
  status: response.status,
  statusText: response.statusText,
  ok: response.ok,
  headers: Object.fromEntries(response.headers.entries())
});

if (!response.ok) {
  const errorText = await response.text();
  throw new Error(`è·å–æŠ“åŒ…çŠ¶æ€å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`);
}
```

### 3. æ™ºèƒ½é‡è¯•æœºåˆ¶
**é—®é¢˜**ï¼šç½‘ç»œä¸´æ—¶æ•…éšœå¯¼è‡´è½®è¯¢ä¸­æ–­

**ä¿®å¤**ï¼šæ·»åŠ æœ€å¤§3æ¬¡çš„è‡ªåŠ¨é‡è¯•æœºåˆ¶
```typescript
const isRetryableError = (error as Error).name === 'TypeError' || 
                        (error as Error).name === 'AbortError' ||
                        (error as Error).message.includes('fetch') ||
                        (error as Error).message.includes('timeout') ||
                        (error as Error).message.includes('network');

if (isRetryableError && retryCount <= maxRetries) {
  console.log(`ğŸ”„ é‡è¯•æ¬¡æ•°: ${retryCount}/${maxRetries}`);
  return; // ç»§ç»­è½®è¯¢
}
```

### 4. ç”¨æˆ·å‹å¥½çš„çŠ¶æ€æ˜¾ç¤º
**é—®é¢˜**ï¼šç”¨æˆ·æ— æ³•çœ‹åˆ°é”™è¯¯çŠ¶æ€

**ä¿®å¤**ï¼šåœ¨UIä¸­æ˜¾ç¤ºé‡è¯•çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
```typescript
æ¯5ç§’è‡ªåŠ¨æ›´æ–°çŠ¶æ€...
{session.retry_count > 0 && (
  <span className="text-orange-500">(é‡è¯•: {session.retry_count}/3)</span>
)}

{session.status === 'error' && (
  <div className="text-red-600">âŒ ç›‘æ§å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
)}
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### é”™è¯¯å¤„ç†æ”¹è¿›
- âœ… å…¼å®¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨
- âœ… æä¾›è¯¦ç»†çš„é”™è¯¯è¯Šæ–­ä¿¡æ¯
- âœ… è‡ªåŠ¨é‡è¯•ç½‘ç»œä¸´æ—¶æ•…éšœ
- âœ… ç”¨æˆ·å‹å¥½çš„é”™è¯¯çŠ¶æ€æ˜¾ç¤º

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹
```
ğŸ”„ è½®è¯¢æŠ“åŒ…çŠ¶æ€: capture_1751894075
ğŸ“¡ APIå“åº”çŠ¶æ€: {status: 200, statusText: "OK", ok: true}
âœ… æŠ“åŒ…çŠ¶æ€æ›´æ–°: {session_id: "capture_1751894075", is_capturing: true, ...}
```

### é‡è¯•æœºåˆ¶ç¤ºä¾‹
```
ğŸ”„ ç½‘ç»œé”™è¯¯æˆ–è¶…æ—¶ï¼Œé‡è¯•æ¬¡æ•°: 1/3ï¼Œå°†åœ¨ä¸‹æ¬¡è½®è¯¢æ—¶é‡è¯•...
ğŸ”„ ç½‘ç»œé”™è¯¯æˆ–è¶…æ—¶ï¼Œé‡è¯•æ¬¡æ•°: 2/3ï¼Œå°†åœ¨ä¸‹æ¬¡è½®è¯¢æ—¶é‡è¯•...
âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°(3)ï¼Œåœæ­¢è½®è¯¢
```

## ğŸ› ï¸ æŠ€æœ¯ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶
- `frontend/components/ai-diagnosis/ChatInterface.tsx`
  - ä¿®å¤ `pollCaptureStatus` å‡½æ•°çš„å…¼å®¹æ€§
  - æ·»åŠ é‡è¯•æœºåˆ¶å’Œè¯¦ç»†é”™è¯¯å¤„ç†
  - æ”¹è¿›UIçŠ¶æ€æ˜¾ç¤º

### æ–°å¢çš„æ¥å£å­—æ®µ
```typescript
interface PacketCaptureSession {
  // ... ç°æœ‰å­—æ®µ
  retry_count?: number; // æ–°å¢ï¼šé‡è¯•è®¡æ•°å™¨
}
```

### è¶…æ—¶è®¾ç½®
- çŠ¶æ€æŸ¥è¯¢è¶…æ—¶ï¼š10ç§’
- AIåˆ†æè¶…æ—¶ï¼š30ç§’
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š3æ¬¡

## ğŸ“Š æµ‹è¯•éªŒè¯

### APIæµ‹è¯•
```bash
curl -s http://localhost:3000/api/packet-capture-status | jq '.'
# è¿”å›æ­£å¸¸çš„JSONå“åº”ï¼ŒçŠ¶æ€ç 200
```

### åŠŸèƒ½æµ‹è¯•
1. âœ… æ­£å¸¸æƒ…å†µä¸‹è½®è¯¢å·¥ä½œæ­£å¸¸
2. âœ… ç½‘ç»œä¸­æ–­æ—¶è‡ªåŠ¨é‡è¯•
3. âœ… è¾¾åˆ°é‡è¯•ä¸Šé™æ—¶åœæ­¢è½®è¯¢
4. âœ… é”™è¯¯çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºç»™ç”¨æˆ·

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæˆ‘ä»¬è§£å†³äº†ï¼š
- **å…¼å®¹æ€§é—®é¢˜**ï¼šæ”¯æŒæ‰€æœ‰ç°ä»£æµè§ˆå™¨
- **å¯è§‚æµ‹æ€§é—®é¢˜**ï¼šè¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’ŒçŠ¶æ€æ˜¾ç¤º  
- **å¥å£®æ€§é—®é¢˜**ï¼šæ™ºèƒ½é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
- **ç”¨æˆ·ä½“éªŒé—®é¢˜**ï¼šå‹å¥½çš„é”™è¯¯çŠ¶æ€æç¤º

ç°åœ¨çš„æŠ“åŒ…ç›‘æ§ç³»ç»Ÿæ›´åŠ ç¨³å®šå¯é ï¼Œèƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„è¯Šæ–­ä½“éªŒã€‚ 